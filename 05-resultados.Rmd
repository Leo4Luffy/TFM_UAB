```{r, echo = FALSE}

pacman::p_load(cowplot, magick, tibble, gt, dplyr, ggplot2, showtext, here, readr, latex2exp, reshape2, ggforce)
font_add_google('Gochi Hand', 'gochi')
showtext_auto()
```

<!-- Para renderizar: bookdown::render_book("index.Rmd", "bookdown::pdf_book") -->

# Resultados

## Matrices de parentesco

La matriz de parentesco combinada (o matriz H), tuvo un rango más amplio de variación del parentesco entre individuos en comparación con la matriz basada solo en información de pedigrí (o matriz A), situación que se puede observar en la Figuras 5.1 y 5.2, y en el Anexo A.3.

Al no conocer su herencia, la matriz A identifico a los individuos de la población fundadora como no relacionados (Figura 5.1), contrario con la matriz H en la cual, al capturar las relaciones históricas, se evidenció que entre los individuos de la población fundadora si puede existir una relación (Anexo A.3).

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

###########
# Pedigrí 1
###########

#####################
# Densidad de 100.000
#####################

# Con ningún individuo genotipado ---- 

mA_ped1 <- readRDS(here('figures', 'mA_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mA_ped1_map <- melt(mA_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mA_ped1_map <- mA_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  labs(title = 'Matriz A', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

mA_ped1 <- mA_ped1 %>%
  replace(., col(.) == row(.), NA) # Los elementos de la diagonal de la matriz se reemplazan por NA.

mA_ped1_map_b <- melt(mA_ped1)

mA_ped1_map_b <- mA_ped1_map_b %>%
  ggplot(data = ., aes(x = value, after_stat(density))) +
  geom_histogram(colour = 'cyan', fill = 'cyan', alpha = 0.2, bins = 5) +
  labs(title = 'Matriz A', x = 'relación', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 7, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    )

# Con 148 individuos genotipados ---- 

mHa_ped1 <- readRDS(here('figures', 'mHa_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mHa_ped1_map <- melt(mHa_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mHa_ped1_map <- mHa_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  labs(x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con 298 individuos genotipados ---- 

mHb_ped1 <- readRDS(here('figures', 'mHb_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mHb_ped1_map <- melt(mHb_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mHb_ped1_map <- mHb_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  labs(x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con 451 individuos genotipados ---- 

mHc_ped1 <- readRDS(here('figures', 'mHc_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mHc_ped1_map <- melt(mHc_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mHc_ped1_map <- mHc_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  #facet_zoom(xlim = c(35, 40), ylim = c(35, 40)) +
  labs(title = 'Matriz H', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

mHc_ped1 <- mHc_ped1 %>%
  replace(., col(.) == row(.), NA) # Los elementos de la diagonal de la matriz se reemplazan por NA.

mHc_ped1_map_b <- melt(mHc_ped1)

mHc_ped1_map_b <- mHc_ped1_map_b %>%
  ggplot(data = ., aes(x = value, after_stat(density))) +
  geom_histogram(colour = 'cyan', fill = 'cyan', alpha = 0.2, bins = 5) +
  labs(title = 'Matriz H (451 individuos genotipados)', x = 'relación', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 7, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    )

(mA_ped1_map | mHc_ped1_map) -> map_A_H_Molcoanc

knitr::include_graphics('figures/map_A_H_Molcoanc.pdf', auto_pdf = TRUE)
```

::: {.center data-latex=""}
__Figura 5.1:__ Mapas de calor de las matrices A y H, esta última estimada a partir de 451 individuos genotipados con una densidad de marcador aproximado de 100.000, de 50 individuos pertencientes a la generación $F_{0}$ del pedigrí 1 (primera replica) generado a partir de simulación ancestral. Los colores en gris (fuera de la diagonal) indican que existe relación entre pares de individuos.
:::

Al observar la relación entre hermanos completos, la matriz H proporcionó estimaciones de parentescos más detalladas en comparación con la matriz A (Figura 5.2). En la matriz H, todos los hermanos completos no estuvieron igualmente relacionados entre sí (como lo indica las relaciones genéticas esperadas debido al pedigrí), en su lugar, se produjo un continuo de las relaciones genéticas realizadas entre pares de individuos.

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

###########
# Pedigrí 3
###########

#####################
# Densidad de 100.000
#####################

# Con ningún individuo genotipado ---- 

mA_ped3 <- readRDS(here('figures', 'mA_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mA_ped3_map <- melt(mA_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mA_ped3_map <- mA_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz A', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con los individuos de la generación F2 genotipados ---- 

mHa_ped3 <- readRDS(here('figures', 'mHa_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mHa_ped3_map <- melt(mHa_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz H al formato largo.

mHa_ped3_map <- mHa_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz H (F2 genotipados)', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con los individuos de las generaciones F2 y F3 genotipados ---- 

mHb_ped3 <- readRDS(here('figures', 'mHb_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mHb_ped3_map <- melt(mHb_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz H al formato largo.

mHb_ped3_map <- mHb_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz H (F2-F3 genotipados)', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con todos los individuos genotipados ---- 

mHc_ped3 <- readRDS(here('figures', 'mHc_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mHc_ped3_map <- melt(mHc_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz H al formato largo.

mHc_ped3_map <- mHc_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz H (F0-F1-F2-F3 genotipados)', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

(mA_ped3_map | mHa_ped3_map) / (mHb_ped3_map | mHc_ped3_map) -> map_A_H_SeqBreed

knitr::include_graphics('figures/map_A_H_SeqBreed.pdf', auto_pdf = TRUE)
```

::: {.center data-latex=""}
__Figura 5.2:__ Mapas de calor de las matrices A y H, esta última estimada a partir de diferentes cantidades de individuos genotipados con una densidad de marcador aproximado de 100.000, de 40 individuos de la generación $F_{1}$ del pedigrí 3 (primera replica) generado a partir de simulación de descendientes. Las escalas muestran el continuo de las relaciones genéticas entre pares de individuos, desde ninguna relación (áreas en blanco con valores iguales a 0) a relaciones completas (áreas en gris con valores en torno a 0.5).
:::

Estos resultados indican una mejor capacidad de diferenciación de las relaciones entre individuos al usar la matriz H, ya que en el calculo de esta última se considera el intercambio de alelos o la segregación mendeliana, y las relaciones genéticas a través de ancestros comunes desconocidos que pueden no estar disponibles en los registros genealógicos [@cite:68].

## Componentes de varianza y heredabilidad

Los resultados de la estima de heredabilidad (en sentido estricto) para el carácter tiempo de floración, mediante procedimientos Bayesianos y de máxima verosimilitud restringida (REML) bajo el método BLUP en los tres pedigríes generados a partir de simulación ancestral, se resumen en la Tabla 5.1 y en la Figura 5.3. Esta estima, definida como la relación entre la varianza genética aditiva y la varianza fenotípica, varió de 0.72 a 0.84 mediante procedimientos Bayesianos, y de 0.79 a 0.84 mediante REML, valores que indican que el tiempo de floración es un carácter muy heredable. En ambos enfoques (Bayesianos y REML), el BLUP proporcionó estimaciones de heredabilidad muy similares.

::: {.center data-latex=""}
__Tabla 5.1:__ Estimaciones de componentes de varianza y de heredabilidad para el caracter tiempo de floración mediante el método BLUP.
:::

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', warning = FALSE, message=FALSE}

tribble(
  ~'Parámetro', ~'Ped. 1', ~'Ped. 2', ~'Ped. 3', ~'Pedigrí_a', ~'Pedigrí_b', ~'Pedigrí_c',
  'Varianza aditiva', 0.43, 0.50, 0.56, 0.47, 0.50, 0.56,
  'Varianza ambiental', 0.16, 0.14, 0.11, 0.12, 0.13, 0.11,
  'Heredabilidad', 0.72, 0.78, 0.84, 0.80, 0.79, 0.84
  ) %>%
  gt() %>%
  cols_label(
    Pedigrí_a = 'Ped. 1',
    Pedigrí_b = 'Ped. 2',
    Pedigrí_c = 'Ped. 3'
  ) %>%
  tab_spanner(
    label = 'Bayesiano',
    columns = c(2, 3, 4)
    ) %>%
  tab_spanner(
    label = 'REML',
    columns = c(5, 6, 7)
    ) %>%
  tab_footnote(
    footnote = 'Ped. 1 indica Pedigrí 1',
    locations = cells_column_labels(
      columns = 'Ped. 1'
    )
  )
```

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message=FALSE, warning = FALSE}

# Pedigrí 1 (Bayesiano) ----

varU_ped_1 <- read_delim(here('figures', 'varU_ped1.txt'), delim = '\t') %>%
  mutate(varU = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varE_ped_1 <- read_delim(here('figures', 'varE_ped1.txt'), delim = '\t') %>%
  mutate(varE = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

h2_ped_1 <- read_delim(here('figures', 'h2_ped1.txt'), delim = '\t') %>%
  mutate(h2 = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varU_ped1 <- ggplot(data = varU_ped_1, aes(x = varU)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.2) +
  annotate(geom = 'text', x = 0.48, y = 15, label = TeX('$|0.36; 0.51|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.48, y = 13, label = TeX('$\\bar{x} = 0.43$'), size = 4.8) +
  labs(title = 'Pedigrí 1 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_ped1 <- ggplot(data = varE_ped_1, aes(x = varE)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.2) +
  annotate(geom = 'text', x = 0.20, y = 25, label = TeX('$|0.13; 0.23|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.20, y = 23, label = TeX('$\\bar{x} = 0.16$'), size = 4.8) +
  labs(title = 'Pedigrí 1 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_ped1 <- ggplot(data = h2_ped_1, aes(x = h2)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  annotate(geom = 'text', x = 0.65, y = 15, label = TeX('$|0.62; 0.79|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.77, y = 13, label = TeX('$\\bar{x} = 0.72$'), size = 4.8) +
  labs(title = 'Pedigrí 1 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

# Pedigrí 2 (Bayesiano) ----

varU_ped_2 <- read_delim(here('figures', 'varU_ped2.txt'), delim = '\t') %>%
  mutate(varU = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varE_ped_2 <- read_delim(here('figures', 'varE_ped2.txt'), delim = '\t') %>%
  mutate(varE = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

h2_ped_2 <- read_delim(here('figures', 'h2_ped2.txt'), delim = '\t') %>%
  mutate(h2 = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varU_ped2 <- ggplot(data = varU_ped_2, aes(x = varU)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.2) +
  annotate(geom = 'text', x = 0.43, y = 14, label = TeX('$|0.40; 0.58|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.48, y = 13, label = TeX('$\\bar{x} = 0.50$'), size = 4.8) +
  labs(title = 'Pedigrí 2 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_ped2 <- ggplot(data = varE_ped_2, aes(x = varE)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.2) +
  annotate(geom = 'text', x = 0.17, y = 24, label = TeX('$|0.10; 0.19|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.20, y = 23, label = TeX('$\\bar{x} = 0.14$'), size = 4.8) +
  labs(title = 'Pedigrí 2 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_ped2 <- ggplot(data = h2_ped_2, aes(x = h2)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  annotate(geom = 'text', x = 0.72, y = 14, label = TeX('$|0.69; 0.85|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.77, y = 13, label = TeX('$\\bar{x} = 0.78$'), size = 4.8) +
  labs(title = 'Pedigrí 2 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

# Pedigrí 3 (Bayesiano) ----

varU_ped_3 <- read_delim(here('figures', 'varU_ped3.txt'), delim = '\t') %>%
  mutate(varU = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varE_ped_3 <- read_delim(here('figures', 'varE_ped3.txt'), delim = '\t') %>%
  mutate(varE = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

h2_ped_3 <- read_delim(here('figures', 'h2_ped3.txt'), delim = '\t') %>%
  mutate(h2 = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varU_ped3 <- ggplot(data = varU_ped_3, aes(x = varU)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.2) +
  annotate(geom = 'text', x = 0.475, y = 14, label = TeX('$|0.35; 0.65|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.48, y = 13, label = TeX('$\\bar{x} = 0.56$'), size = 4.8) +
  labs(title = 'Pedigrí 3 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_ped3 <- ggplot(data = varE_ped_3, aes(x = varE)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.2) +
  annotate(geom = 'text', x = 0.14, y = 24, label = TeX('$|0.08; 0.16|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.20, y = 23, label = TeX('$\\bar{x} = 0.11$'), size = 4.8) +
  labs(title = 'Pedigrí 3 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 9, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_ped3 <- ggplot(data = h2_ped_3, aes(x = h2)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  annotate(geom = 'text', x = 0.786, y = 14, label = TeX('$|0.76; 0.89|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.77, y = 13, label = TeX('$\\bar{x} = 0.83$'), size = 4.8) +
  labs(title = 'Pedigrí 3 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

(varU_ped1 | varE_ped1 | h2_ped1) / (varU_ped2 | varE_ped2 | h2_ped2) / (varU_ped3 | varE_ped3 | h2_ped3) -> covar_h2

(h2_ped1 | h2_ped2 | h2_ped3) -> covar_h2_2

knitr::include_graphics('figures/covar_h2.pdf', auto_pdf = TRUE)
```

::: {.center data-latex=""}
__Figura 5.3:__ Distribuciones posteriores de componentes de varianza y de heredabilidad obtenidas mediante enfoques Bayesianos. Los valores presentados en la Tabla 5.1 (para el enfoque Bayesiano), corresponden a la media calculada a partir de estas distribuciones.
:::

## Precisión de la predición mediante simulación de pedigrí ancestral y de descendientes

El efecto de la densidad del marcador y de la cantidad de individuos genotipados sobre la precisión de la predicción para el caracter tiempo de floración, se evaluó a través del coeficiente de correlación entre los valores fenotípicos observados y predichos, resultados que se resumen en las Figuras 5.4 y 5.5 y en los Anexos A.4 y A.5. En general, y como era de esperar, la precisión de la predicción aumento a medida que aumentaban tanto la densidad del marcador como la cantidad de individuos genotipados.

En relación a la precisión de la predicción debido a la densidad del marcador en la simulación ancestral (Figura 5.4 y Anexo A.4), esta fue mayor cuando se consideró una densidad del marcador igual a 0 en comparación a una densidad aproximada de 1.000 (en todos los casos de individuos genotipados). Al considerar una densidad del marcador por encima de 1.000, dicha precisión tendió a aumentar hasta alcanzar la precisión de la predicción más alta cuando se usaron todos los marcadores disponibles (aunque en el caso en el que se consideró el genotipado de 148 individuos, la precisión de la predicción usando 10.000 y 100.000 marcadores no pudo superar el caso donde se consideró una densidad igual a 0). Sin embargo, dado el aumento marginal en la precisión de la predicción al aumentar de 10.000 a 100.000 marcadores, fue posible afirmar que el limite en el aumento de la precisión se alcanzó en aproximadamente 10.000 marcadores. Por otra parte, el desvió estándar de las precisiones de predicción fue similar a medida que el número de marcadores aumentaba. Este comportamiento de la densidad del marcador sobre la precisión de la predicción curiosamente se observó por igual en los tres pedigríes simulados, tanto en el enfoque Bayesiano como en REML.

En cuanto a la cantidad de individuos genotipados, la precisión de la predicción aumentó sustancialmente al pasar de 148 a 451 individuos genotipados (en todos los casos de densidades de SNP). A diferencia de lo mencionado en el párrafo anterior para la densidad del marcador, no se pudo observar un punto en el que la precisión de la predicción se estabilizara en respuesta al aumento en la cantidad de individuos genotipados, situación que demuestra la importancia de un tamaño adecuado del conjunto de entrenamiento para construir modelos de predicción genómica. Adicionalmente, el desvió estándar de las precisiones disminuyo a medida que aumentaba la cantidad de individuos genotipados, hecho que pone de manifiesto que la diferencia en la precisión de la predicción es más alta en conjuntos de entrenamiento más pequeños. Al igual que lo mencionado  en el párrafo anterior para la densidad del marcador, se observó un comportamiento muy similar en la precisión de la predicción debido a la cantidad de individuos genotipados en los tres pedigríes simulados y en ambos enfoques (Bayesiano y REML).

```{r, eval = FALSE, echo = FALSE}

####################
# Enfoque penalizado
####################

Ped1_Pen <- read_delim(here('figures', 'Ped1_Pen.txt'), delim = '\t') %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 1'
    )

# Diferencias entre distintos individuos genotipados con una densidad de SNP de 1.000 y con el enfoque REML ----

Ped1_Pen_1.000 <- Ped1_Pen %>%
  filter(Densidad == '1.000' | Densidad == '0')

mod_comp_1 <- aov(formula = Correlación ~ Genotipados, data = Ped1_Pen_1.000)
summary(mod_comp_1)
TukeyHSD(mod_comp_1) # Aquí se ve que no hay diferencias entre 148-298, 148-451, pero si hay diferencia entre 298-451.

# Diferencias entre distintos individuos genotipados con una densidad de SNP de 10.000 y con el enfoque REML ----

Ped1_Pen_10.000 <- Ped1_Pen %>%
  filter(Densidad == '10.000' | Densidad == '0')

mod_comp_2 <- aov(formula = Correlación ~ Genotipados, data = Ped1_Pen_10.000)
summary(mod_comp_2)
TukeyHSD(mod_comp_2) # Aquí se ve que no hay diferencia entre 148-298, pero si hay diferencias entre 148-451 y 298-451.

# Diferencias entre distintos individuos genotipados con una densidad de SNP de 100.000 y con el enfoque REML ----

Ped1_Pen_100.000 <- Ped1_Pen %>%
  filter(Densidad == '100.000' | Densidad == '0')

mod_comp_3 <- aov(formula = Correlación ~ Genotipados, data = Ped1_Pen_100.000)
summary(mod_comp_3)
TukeyHSD(mod_comp_3) # Aquí se ve que hay diferencias entre 148-298, 148-451 y 298-451.
```

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

Cor_ped_1_est <- read_delim(here('figures', 'Ped1_Bay_Pen.txt'), delim = '\t') %>%
  mutate(
    Enfoque = recode(
      .x = Enfoque,
      'Penalizado' = 'REML'
      )
    ) %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 1'
    )

Cor_ped_1_est %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(data = Cor_ped_1_est, position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), data = Cor_ped_1_est, width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_wrap(~ Enfoque) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador', title = 'Pedigrí uno') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = 'bold'),
    legend.title = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 13, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) -> Cor_ped_1_est_graf

Cor_ped_2_est <- read_delim(here('figures', 'Ped2_Bay_Pen.txt'), delim = '\t') %>%
  mutate(
    Enfoque = recode(
      .x = Enfoque,
      'Penalizado' = 'REML'
      )
    ) %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 2'
    )

Cor_ped_2_est %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(data = Cor_ped_2_est, position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), data = Cor_ped_2_est, width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_wrap(~ Enfoque) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador', title = 'Pedigrí dos') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = 'bold'),
    legend.title = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 13, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) -> Cor_ped_2_est_graf

Cor_ped_3_est <- read_delim(here('figures', 'Ped3_Bay_Pen.txt'), delim = '\t') %>%
  mutate(
    Enfoque = recode(
      .x = Enfoque,
      'Penalizado' = 'REML'
      )
    ) %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 3'
    )

Cor_ped_3_est %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(data = Cor_ped_3_est, position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), data = Cor_ped_3_est, width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_wrap(~ Enfoque) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador', title = 'Pedigrí tres') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = 'bold'),
    legend.title = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 13, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) -> Cor_ped_3_est_graf

bind_rows(Cor_ped_1_est, Cor_ped_2_est, Cor_ped_3_est) %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_grid(vars(Pedigrí), vars(Enfoque)) +
  annotate(geom = 'text', x = 1.78, y = 0.72, label = 'bc', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 2.0, y = 0.72, label = 'b', size = 2.8, colour = 'black') +
  facet_grid(vars(Pedigrí), vars(Enfoque)) +
  annotate(geom = 'text', x = 1.0, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 2.25, y = 0.72, label = 'ac', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 2.78, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 3.0, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 3.78, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 4.0, y = 0.72, label = 'ab', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 4.22, y = 0.72, label = 'b', size = 2.8, colour = 'black') +
  facet_grid(vars(Pedigrí), vars(Enfoque)) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 11, face = 'bold'),
    legend.title = element_text(size = 11, face = 'bold'),
    legend.text = element_text(size = 11),
    legend.position = 'top',
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 10, colour = 'black', face = 'bold')
    ) -> Cor_Bay_Pen

knitr::include_graphics('figures/Cor_Bay_Pen_2.pdf', auto_pdf = TRUE)
```

::: {.center data-latex=""}
__Figura 5.4:__ Precisión de la predicción con tamaños crecientes en el número de marcadores y de individuos genotipados. Los tres pedigríes (Pedigrí 1-2-3) corresponden a los pedigríes generados en la simulación ancestral. Las barras representan la media de la precisión de la predicción de las 10 replicas de cada pedigrí y las barras de error representan el desvió estándar como medida de variabilidad.
:::

El efecto de la densidad del marcador sobre la precisión de la predicción también se evaluó en la simulación de descendientes (Figura 5.5 y Anexo A.5), observandose en este un comportamiento similar al observado con la simulación ancestral anterior, en el sentido de que fue necesario de una cantidad mínima de marcadores para obtener una precisión equivalente al usar la cantidad máxima, aunque en esta simulación dicha cantidad mínima marcadores fue solo de aproximadamente 1.000. Se observó un aumento irrelevante en la precisión de la predicción al pasar de 1.000 a 10.000 marcadores y de 10.000 a 100.000 marcadores (~ 0.0%), para todos los casos de individuos genotipados. Las mayores ganancias esperadas en la precisión de la predicción se observaron al pasar de 0 a 1.000, 10.000 y 100.000 marcadores, demostrando con esto que las predicciones basadas en información genómica son más precisas que las predicciones basadas solo en información del pedigrí. Este comportamiento de la densidad del marcador sobre la precisión de la predicción se observó por igual en los cuatro pedigríes simulados y considerando los individuos de las generaciones $F_{2}$ y $F_{3}$ como conjuntos de validación.



<!--
La definición de la población genotipada es un factor determinante para la precisión de la predicción bajo evaluación genómica. Para analizar diferentes formas de seleccionar animales para la población genotipada, se probaron varias combinaciones de sexo de los individuos, EBV, conocimiento del pedigrí, año de inicio del genotipado y número de individuos genotipados. En todos los casos, los valores genéticos estimados por ssGBLUP mostraron precisiones más altas (media 0.5841 para LCNEUS, 0.5981 para LCR, 0.5507 para LCNNAF) que las evaluaciones BLUP basadas en pedigrí (media 0.4570 para LCNEUS, 0.5190 para LCR, 0.5111 para LCNNAF), por lo que la media las diferencias de precisión relativa siempre fueron positiva

--

Hay una pérdida en la precisión de GEBV cuando el número de hembras genotipadas disminuye, que es menos notorio según el tamaño de la población genotipada. Esto probablemente se deba a que, aunque estos individuos no tienen un pedigrí completo, sus propios registros, y posiblemente los datos y conexiones de su descendencia, brindan información útil para evaluaciones más precisa

--

Así, la ganancia esperada en precisión a corto plazo para las poblaciones de Latxa estaría en torno al 11%. Los resultados más bajos mostrados por los escenarios restringidos (60% menos de diferencia de precisión que los escenarios no restringidos), resaltaron la relevancia de tener datos genómicos de varias generaciones anteriore

--

como era de esperar ( Meuwissen et al., 2001), la diferencia de precisión relativa aumentó según el número de individuos genotipados en las 3 razas. Se logró un incremento del 60% del 10 al 70% de los escenarios

--


-->

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

Cor_F2_est <- read_delim(here('figures', 'Ped_F2.txt'), delim = '\t') %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Predicción = 'F2',
    Pedigrí = case_when(
      Pedigrí == 'Pedigrí_1' ~ 'Pedigrí 1',
      Pedigrí == 'Pedigrí_2' ~ 'Pedigrí 2',
      Pedigrí == 'Pedigrí_3' ~ 'Pedigrí 3',
      Pedigrí == 'Pedigrí_4' ~ 'Pedigrí 4'
      )
    )

Cor_F3_est <- read_delim(here('figures', 'Ped_F3.txt'), delim = '\t') %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Predicción = 'F3',
    Pedigrí = case_when(
      Pedigrí == 'Pedigrí_1' ~ 'Pedigrí 1',
      Pedigrí == 'Pedigrí_2' ~ 'Pedigrí 2',
      Pedigrí == 'Pedigrí_3' ~ 'Pedigrí 3',
      Pedigrí == 'Pedigrí_4' ~ 'Pedigrí 4'
      )
  )

bind_rows(Cor_F2_est, Cor_F3_est) %>%
  mutate(Genotipados = factor(Genotipados, levels = c('Ninguno', 'F2', 'F1-F2', 'F0-F1-F2-F3'))) %>%
  ggplot(data = .,aes(x = Densidad, y = Media, fill = Genotipados, colour = Genotipados)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Media - Desvio, ymax = Media + Desvio), width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_grid(vars(Pedigrí), vars(Predicción)) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 11, face = 'bold'),
    legend.title = element_text(size = 11, face = 'bold'),
    legend.text = element_text(size = 11),
    legend.position = 'top',
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 10, colour = 'black', face = 'bold')
    ) -> Cor_F2_F3

knitr::include_graphics('figures/Cor_F2_F3.pdf', auto_pdf = TRUE)
```

::: {.center data-latex=""}
__Figura 5.5:__ Precisión de la predicción con tamaños crecientes en el número de marcadores y de individuos genotipados. Los cuatro pedigríes (Pedigrí 1-2-3-4) corresponden a los pedigríes generados en la simulación de descendientes. Las barras representan la media de la precisión de la predicción de las 10 replicas de cada pedigrí y las barras de error representan el desvió estándar como medida de variabilidad.
:::



