```{r, echo = FALSE}

pacman::p_load(cowplot, magick, tibble, gt, dplyr, ggplot2, showtext, here, readr, latex2exp, reshape2, ggforce, FactoMineR, factoextra)
font_add_google('Gochi Hand', 'gochi')
showtext_auto()
```

<!-- Para renderizar: bookdown::render_book("index.Rmd", "bookdown::pdf_book") -->

# Resultados
<!--
## Matrices de parentesco

La matriz de parentesco combinada (o matriz H), tuvo un rango más amplio de variación del parentesco entre individuos en comparación con la matriz basada solo en información del pedigrí (o matriz A), situación que se puede observar en la Figuras 5.1 y 5.2, y en el Anexo A.3.

Al no conocer su herencia, la matriz A identifico a los individuos de la población fundadora como no relacionados (Figura 5.1), contrario con la matriz H en la cual, al capturar las relaciones históricas, se evidenció que entre los individuos de la población fundadora puede existir una relación (Anexo A.3).
-->
```{r, eval = FALSE, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

###########
# Pedigrí 1
###########

#####################
# Densidad de 100.000
#####################

# Con ningún individuo genotipado ---- 

mA_ped1 <- readRDS(here('figures', 'mA_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mA_ped1_map <- melt(mA_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mA_ped1_map <- mA_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  labs(title = 'Matriz A', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

mA_ped1 <- mA_ped1 %>%
  replace(., col(.) == row(.), NA) # Los elementos de la diagonal de la matriz se reemplazan por NA.

mA_ped1_map_b <- melt(mA_ped1)

mA_ped1_map_b <- mA_ped1_map_b %>%
  ggplot(data = ., aes(x = value, after_stat(density))) +
  geom_histogram(colour = 'cyan', fill = 'cyan', alpha = 0.2, bins = 5) +
  labs(title = 'Matriz A', x = 'relación', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 7, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    )

# Con 148 individuos genotipados ---- 

mHa_ped1 <- readRDS(here('figures', 'mHa_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mHa_ped1_map <- melt(mHa_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mHa_ped1_map <- mHa_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  labs(x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con 298 individuos genotipados ---- 

mHb_ped1 <- readRDS(here('figures', 'mHb_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mHb_ped1_map <- melt(mHb_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mHb_ped1_map <- mHb_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  labs(x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con 451 individuos genotipados ---- 

mHc_ped1 <- readRDS(here('figures', 'mHc_ped1_Molcoanc.RDS')) %>%
  as.matrix()

mHc_ped1_map <- melt(mHc_ped1) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mHc_ped1_map <- mHc_ped1_map %>%
  filter(
    Var2 %in% c(1:50),
    Var1 %in% c(1:50)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'black', high = 'yellow') +
  #facet_zoom(xlim = c(35, 40), ylim = c(35, 40)) +
  labs(title = 'Matriz H', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

mHc_ped1 <- mHc_ped1 %>%
  replace(., col(.) == row(.), NA) # Los elementos de la diagonal de la matriz se reemplazan por NA.

mHc_ped1_map_b <- melt(mHc_ped1)

mHc_ped1_map_b <- mHc_ped1_map_b %>%
  ggplot(data = ., aes(x = value, after_stat(density))) +
  geom_histogram(colour = 'cyan', fill = 'cyan', alpha = 0.2, bins = 5) +
  labs(title = 'Matriz H (451 individuos genotipados)', x = 'relación', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 7, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    )

(mA_ped1_map | mHc_ped1_map) -> map_A_H_Molcoanc

knitr::include_graphics('figures/map_A_H_Molcoanc.pdf', auto_pdf = TRUE)
```
<!--
\noindent
__Figura 5.1:__ Mapas de calor de las matrices A y H, esta última estimada a partir de 451 individuos genotipados con una densidad de marcador aproximado de 100.000, de 50 individuos pertenecientes a la generación $F_{0}$ del pedigrí 1 (primera replica) generado a partir de simulación ancestral. Los colores en gris (fuera de la diagonal) indican que existe relación entre pares de individuos.

\hspace*{1em}
Al observar la relación entre hermanos completos, la matriz H proporcionó estimaciones de parentescos más detalladas en comparación con la matriz A (Figura 5.2). En la matriz H, todos los hermanos completos no estuvieron igualmente relacionados entre sí (contrario a lo que indica las relaciones genéticas esperadas debido al pedigrí, donde todos los hermanos completos se relacionan con un valor de 0.5), en su lugar, se produjo un continuo de las relaciones genéticas realizadas entre pares de individuos.
-->
```{r, eval = FALSE, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

###########
# Pedigrí 3
###########

#####################
# Densidad de 100.000
#####################

# Con ningún individuo genotipado ---- 

mA_ped3 <- readRDS(here('figures', 'mA_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mA_ped3_map <- melt(mA_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz A al formato largo.

mA_ped3_map <- mA_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz A', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con los individuos de la generación F2 genotipados ---- 

mHa_ped3 <- readRDS(here('figures', 'mHa_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mHa_ped3_map <- melt(mHa_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz H al formato largo.

mHa_ped3_map <- mHa_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz H (F2 genotipados)', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con los individuos de las generaciones F2 y F3 genotipados ---- 

mHb_ped3 <- readRDS(here('figures', 'mHb_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mHb_ped3_map <- melt(mHb_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz H al formato largo.

mHb_ped3_map <- mHb_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz H (F2-F3 genotipados)', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

# Con todos los individuos genotipados ---- 

mHc_ped3 <- readRDS(here('figures', 'mHc_ped3_SeqBreed.RDS')) %>%
  as.matrix()

mHc_ped3_map <- melt(mHc_ped3) # Usando la función melt() del paquete "reshape2" se convertie la matriz H al formato largo.

mHc_ped3_map <- mHc_ped3_map %>%
  filter(
    Var2 %in% c(452:491),
    Var1 %in% c(452:491)
    ) %>%
  ggplot(data = ., aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = 'yellow', high = 'black', labels = function(x) sprintf('%.2f', x)) +
  labs(title = 'Matriz H (F0-F1-F2-F3 genotipados)', x = 'Individuos', y = 'Individuos', fill = 'Relación') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    legend.title = element_text(size = 9, face = 'bold')
    )

(mA_ped3_map | mHa_ped3_map) / (mHb_ped3_map | mHc_ped3_map) -> map_A_H_SeqBreed

knitr::include_graphics('figures/map_A_H_SeqBreed.pdf', auto_pdf = TRUE)
```
<!--
\noindent
__Figura 5.2:__ Mapas de calor de las matrices A y H, esta última estimada a partir de diferentes cantidades de individuos genotipados con una densidad de marcador aproximado de 100.000, de 40 individuos de la generación $F_{1}$ del pedigrí 3 (primera replica) generado a partir de simulación de descendientes. Las escalas muestran el continuo de las relaciones genéticas entre pares de individuos, desde ninguna relación (áreas en blanco con valores iguales a 0) a relaciones completas (áreas en gris con valores en torno a 0.5).

\hspace*{1em}
Estos resultados indican una mejor capacidad de diferenciación de las relaciones entre individuos al usar la matriz H, ya que en el calculó de esta última se considera el intercambio de alelos o la segregación mendeliana, y las relaciones genéticas a través de ancestros comunes desconocidos que pueden no estar disponibles en los registros genealógicos [@cite:68].
-->
## Estructura poblacional y heredabilidad en la simulación ancestral

Se examinó si había alguna evidencia de estructura poblacional a partir de la matriz H resultante tanto de la simulación ancestral como de descendientes, de la cual no se observó una estructura poblacional clara según los primeros dos componentes principales (Figuras 5.1 y 5.2). De acuerdo a @cite:69, el hecho de que la mayor parte de la variación total sea explicada por unos pocos valores propios (en este estudio, los primeros diez a veinte valores propios explicaron el 80.0 % de la variación total), sugiere que la población no es especialmente variable, lo cual era de esperar dado el método implementado de generación de individuos a través de la simulación del pedigrí ancestral y de descendientes. Con esta estrategia se trató de replicar los métodos que se emplean en la mejora de los cultivos de arroz, esto es, generación inicial de híbridos a partir del cruzamiento entre distintos individuos, y posterior recombinación en distintas generaciones y por autopolinización. La ausencia de estructura poblacional, según @cite:70, es un escenario favorable para obtener estimaciones confiables de predicción genómica.

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

###########
# Pedigrí 1
###########

################################
# Con 451 individuos genotipados
################################

# Con una densidad de marcador de 1.000 ----

#mHd_ped1 <- readRDS(here('figures', 'mHd_ped1_Molcoanc.RDS')) %>%
  #as.matrix()

#analisis_PCA <- PCA(X = mHd_ped1, graph = FALSE, scale.unit = FALSE) # Con la función PCA() del paquete "FactoMineR" se realiza en análisis de componentes principales.

#val_propio <- get_eigenvalue(X = analisis_PCA) # Con la función get_eigenvalue() del paquete factoextra se pueden extraer los valores propios, es decir, la proporción de la variación retenidos por cada componente principal.

#val_propio %>%
  #as_tibble() %>%
  #select(cumulative.variance.percent) %>%
  #mutate(prop_varianza = cumulative.variance.percent / 100) %>%
  #rowid_to_column(var = 'Componentes') %>%
  #ggplot(data = ., aes(x = Componentes, y = prop_varianza)) +
  #geom_point(colour = 'yellow', alpha = 0.2, size = 1.8) +
  #annotate(geom = 'segment', x = 0, xend = 752, y = 1.0, yend = 1.0, colour = 'black', linetype = 'dashed') +
  #labs(title = 'Matriz H (densidad de 1.000)', x = 'Componentes principales', y = 'Proporción de\n la varianza') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold'),
    #plot.title = element_text(size = 8, face = 'bold')
    #) -> Graf_val_propio_mH_1 # Un método para determinar el número de componentes principales es mirar este gráfico.

#fviz_pca_ind(X = analisis_PCA, label = 'none', col.ind = 'cyan', alpha.ind = 0.2, ) +
  #labs(title = '', x = 'Primer componente (30.3%)', y = 'Segundo componente\n (18.6%)') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold')
    #) -> Graf_PCA_mH_1

#(Graf_val_propio_mH_1 | Graf_PCA_mH_1) -> PCA_mH_1

# Con una densidad de marcador de 10.000 ----

#mHe_ped1 <- readRDS(here('figures', 'mHe_ped1_Molcoanc.RDS')) %>%
  #as.matrix()

#analisis_PCA <- PCA(X = mHe_ped1, graph = FALSE, scale.unit = FALSE) # Con la función PCA() del paquete "FactoMineR" se realiza en análisis de componentes principales.

#val_propio <- get_eigenvalue(X = analisis_PCA) # Con la función get_eigenvalue() del paquete factoextra se pueden extraer los valores propios, es decir, la proporción de la variación retenidos por cada componente principal.

#val_propio %>%
  #as_tibble() %>%
  #select(cumulative.variance.percent) %>%
  #mutate(prop_varianza = cumulative.variance.percent / 100) %>%
  #rowid_to_column(var = 'Componentes') %>%
  #ggplot(data = ., aes(x = Componentes, y = prop_varianza)) +
  #geom_point(colour = 'yellow', alpha = 0.2, size = 1.8) +
  #annotate(geom = 'segment', x = 0, xend = 752, y = 1.0, yend = 1.0, colour = 'black', linetype = 'dashed') +
  #labs(title = 'Matriz H (densidad de 10.000)', x = 'Componentes principales', y = 'Proporción de\n la varianza') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold'),
    #plot.title = element_text(size = 8, face = 'bold')
    #) -> Graf_val_propio_mH_2 # Un método para determinar el número de componentes principales es mirar este gráfico.

#fviz_pca_ind(X = analisis_PCA, label = 'none', col.ind = 'cyan', alpha.ind = 0.2, ) +
  #labs(title = '', x = 'Primer componente (28.1%)', y = 'Segundo componente\n (19.4%)') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold')
    #) -> Graf_PCA_mH_2

#(Graf_val_propio_mH_2 | Graf_PCA_mH_2) -> PCA_mH_2

# Con una densidad de marcador de 100.000 ----

#mHc_ped1 <- readRDS(here('figures', 'mHc_ped1_Molcoanc.RDS')) %>%
  #as.matrix()

#analisis_PCA <- PCA(X = mHc_ped1, graph = FALSE, scale.unit = FALSE) # Con la función PCA() del paquete "FactoMineR" se realiza en análisis de componentes principales.

#val_propio <- get_eigenvalue(X = analisis_PCA) # Con la función get_eigenvalue() del paquete factoextra se pueden extraer los valores propios, es decir, la proporción de la variación retenidos por cada componente principal.

#val_propio %>%
  #as_tibble() %>%
  #select(cumulative.variance.percent) %>%
  #mutate(prop_varianza = cumulative.variance.percent / 100) %>%
  #rowid_to_column(var = 'Componentes') %>%
  #ggplot(data = ., aes(x = Componentes, y = prop_varianza)) +
  #geom_point(colour = 'yellow', alpha = 0.2, size = 1.8) +
  #annotate(geom = 'segment', x = 0, xend = 752, y = 1.0, yend = 1.0, colour = 'black', linetype = 'dashed') +
  #labs(title = 'Matriz H (densidad de 100.000)', x = 'Componentes principales', y = 'Proporción de\n la varianza') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold'),
    #plot.title = element_text(size = 8, face = 'bold')
    #) -> Graf_val_propio_mH_3 # Un método para determinar el número de componentes principales es mirar este gráfico.

#fviz_pca_ind(X = analisis_PCA, label = 'none', col.ind = 'cyan', alpha.ind = 0.2, ) +
  #labs(title = '', x = 'Primer componente (30.1%)', y = 'Segundo componente\n (19.0%)') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 9, face = 'bold')
    #) -> Graf_PCA_mH_3

#(Graf_val_propio_mH_3 | Graf_PCA_mH_3) -> PCA_mH_3

#(Graf_val_propio_mH_1 | Graf_PCA_mH_1) / (Graf_val_propio_mH_2 | Graf_PCA_mH_2) / (Graf_val_propio_mH_3 | Graf_PCA_mH_3) -> Graf_PCA_mH_Molcoanc

knitr::include_graphics('figures/Graf_PCA_mH_Molcoanc.pdf', auto_pdf = TRUE)
```

\noindent
__Figura 5.1:__ Análisis de componentes principales a partir de la matriz H resultante de la simulación ancestral. Aquí, la matriz H se estimó a partir de 451 individuos genotipados con densidad de marcador aproximada de 1.000, 10.000 y 100.000, y en el pedigrí 1 (primera réplica) mediante simulación ancestral.

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

###########
# Pedigrí 3
###########

################################################
# Todos los individuos genotipados (F0-F1-F2-F3)
################################################

# Con una densidad de marcador de 0 ----

#mA_ped3 <- readRDS(here('figures', 'mA_ped3_SeqBreed.RDS')) %>%
  #as.matrix()

#analisis_PCA <- PCA(X = mA_ped3, graph = FALSE, scale.unit = FALSE) # Con la función PCA() del paquete "FactoMineR" se realiza en análisis de componentes principales.

#val_propio <- get_eigenvalue(X = analisis_PCA) # Con la función get_eigenvalue() del paquete factoextra se pueden extraer los valores propios, es decir, la proporción de la variación retenidos por cada componente principal.

#val_propio %>%
  #as_tibble() %>%
  #select(cumulative.variance.percent) %>%
  #mutate(prop_varianza = cumulative.variance.percent / 100) %>%
  #rowid_to_column(var = 'Componentes') %>%
  #ggplot(data = ., aes(x = Componentes, y = prop_varianza)) +
  #geom_point(colour = 'yellow', alpha = 0.2, size = 1.8) +
  #annotate(geom = 'segment', x = 0, xend = 2092, y = 1.0, yend = 1.0, colour = 'black', linetype = 'dashed') +
  #labs(title = '', x = 'Componentes principales', y = 'Proporción de la varianza') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 10, face = 'bold'),
    #axis.title = element_text(size = 10, face = 'bold'),
    #legend.title = element_text(size = 9, face = 'bold')
    #) -> Graf_val_propio_mA # Un método para determinar el número de componentes principales es mirar este gráfico.

#fviz_pca_ind(X = analisis_PCA, label = 'none', col.ind = 'cyan', alpha.ind = 0.2, ) +
  #labs(title = '', x = 'Primer componente (5.5%)', y = 'Segundo componente (3.8%)') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 10, face = 'bold'),
    #axis.title = element_text(size = 10, face = 'bold'),
    #legend.title = element_text(size = 9, face = 'bold')
    #) -> Graf_PCA_mA

#(Graf_val_propio_mA | Graf_PCA_mA) -> PCA_mA

# Con una densidad de marcador de 1.000 ----

#mHd_ped3 <- readRDS(here('figures', 'mHd_ped3_SeqBreed.RDS')) %>%
  #as.matrix()

#analisis_PCA <- PCA(X = mHd_ped3, graph = FALSE, scale.unit = FALSE) # Con la función PCA() del paquete "FactoMineR" se realiza en análisis de componentes principales.

#val_propio <- get_eigenvalue(X = analisis_PCA) # Con la función get_eigenvalue() del paquete factoextra se pueden extraer los valores propios, es decir, la proporción de la variación retenidos por cada componente principal.

#val_propio %>%
  #as_tibble() %>%
  #select(cumulative.variance.percent) %>%
  #mutate(prop_varianza = cumulative.variance.percent / 100) %>%
  #rowid_to_column(var = 'Componentes') %>%
  #ggplot(data = ., aes(x = Componentes, y = prop_varianza)) +
  #geom_point(colour = 'yellow', alpha = 0.2, size = 1.8) +
  #annotate(geom = 'segment', x = 0, xend = 2092, y = 1.0, yend = 1.0, colour = 'black', linetype = 'dashed') +
  #labs(title = 'Matriz H (densidad de 1.000)', x = 'Componentes principales', y = 'Proporción de\n la varianza') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold'),
    #plot.title = element_text(size = 8, face = 'bold')
    #) -> Graf_val_propio_mH_1 # Un método para determinar el número de componentes principales es mirar este gráfico.

#fviz_pca_ind(X = analisis_PCA, label = 'none', col.ind = 'cyan', alpha.ind = 0.2, ) +
  #labs(title = '', x = 'Primer componente (16.4%)', y = 'Segundo componente\n (13.0%)') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold')
    #) -> Graf_PCA_mH_1

#(Graf_val_propio_mH_1 | Graf_PCA_mH_1) -> PCA_mH_1

# Con una densidad de marcador de 10.000 ----

#mHe_ped3 <- readRDS(here('figures', 'mHe_ped3_SeqBreed.RDS')) %>%
  #as.matrix()

#analisis_PCA <- PCA(X = mHe_ped3, graph = FALSE, scale.unit = FALSE) # Con la función PCA() del paquete "FactoMineR" se realiza en análisis de componentes principales.

#val_propio <- get_eigenvalue(X = analisis_PCA) # Con la función get_eigenvalue() del paquete factoextra se pueden extraer los valores propios, es decir, la proporción de la variación retenidos por cada componente principal.

#val_propio %>%
  #as_tibble() %>%
  #select(cumulative.variance.percent) %>%
  #mutate(prop_varianza = cumulative.variance.percent / 100) %>%
  #rowid_to_column(var = 'Componentes') %>%
  #ggplot(data = ., aes(x = Componentes, y = prop_varianza)) +
  #geom_point(colour = 'yellow', alpha = 0.2, size = 1.8) +
  #annotate(geom = 'segment', x = 0, xend = 2092, y = 1.0, yend = 1.0, colour = 'black', linetype = 'dashed') +
  #labs(title = 'Matriz H (densidad de 10.000)', x = 'Componentes principales', y = 'Proporción de\n la varianza') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold'),
    #plot.title = element_text(size = 8, face = 'bold')
    #) -> Graf_val_propio_mH_2 # Un método para determinar el número de componentes principales es mirar este gráfico.

#fviz_pca_ind(X = analisis_PCA, label = 'none', col.ind = 'cyan', alpha.ind = 0.2, ) +
  #labs(title = '', x = 'Primer componente (15.7%)', y = 'Segundo componente\n (13.1%)') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold')
    #) -> Graf_PCA_mH_2

#(Graf_val_propio_mH_2 | Graf_PCA_mH_2) -> PCA_mH_2

# Con una densidad de marcador de 100.000 ----

#mHc_ped3 <- readRDS(here('figures', 'mHc_ped3_SeqBreed.RDS')) %>%
  #as.matrix()

#analisis_PCA <- PCA(X = mHc_ped3, graph = FALSE, scale.unit = FALSE) # Con la función PCA() del paquete "FactoMineR" se realiza en análisis de componentes principales.

#val_propio <- get_eigenvalue(X = analisis_PCA) # Con la función get_eigenvalue() del paquete factoextra se pueden extraer los valores propios, es decir, la proporción de la variación retenidos por cada componente principal.

#val_propio %>%
  #as_tibble() %>%
  #select(cumulative.variance.percent) %>%
  #mutate(prop_varianza = cumulative.variance.percent / 100) %>%
  #rowid_to_column(var = 'Componentes') %>%
  #ggplot(data = ., aes(x = Componentes, y = prop_varianza)) +
  #geom_point(colour = 'yellow', alpha = 0.2, size = 1.8) +
  #annotate(geom = 'segment', x = 0, xend = 2092, y = 1.0, yend = 1.0, colour = 'black', linetype = 'dashed') +
  #labs(title = 'Matriz H (densidad de 100.000)', x = 'Componentes principales', y = 'Proporción de\n la varianza') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 8, face = 'bold'),
    #plot.title = element_text(size = 8, face = 'bold')
    #) -> Graf_val_propio_mH_3 # Un método para determinar el número de componentes principales es mirar este gráfico.

#fviz_pca_ind(X = analisis_PCA, label = 'none', col.ind = 'cyan', alpha.ind = 0.2, ) +
  #labs(title = '', x = 'Primer componente (15.4%)', y = 'Segundo componente\n (13.2%)') +
  #theme_bw() +
  #theme(
    #axis.text = element_text(size = 8, face = 'bold'),
    #axis.title = element_text(size = 8, face = 'bold'),
    #legend.title = element_text(size = 9, face = 'bold')
    #) -> Graf_PCA_mH_3

#(Graf_val_propio_mH_3 | Graf_PCA_mH_3) -> PCA_mH_3

#(Graf_val_propio_mH_1 | Graf_PCA_mH_1) / (Graf_val_propio_mH_2 | Graf_PCA_mH_2) / (Graf_val_propio_mH_3 | Graf_PCA_mH_3) -> Graf_PCA_mH_SeqBreed

knitr::include_graphics('figures/Graf_PCA_mH_SeqBreed.pdf', auto_pdf = TRUE)
```

\noindent
__Figura 5.2:__ Análisis de componentes principales a partir de la matriz H resultante de la simulación de descendientes. Aquí, la matriz H se estimó a partir de 2091 individuos genotipados con densidad de marcador aproximada de 1.000, 10.000 y 100.000, y en el pedigrí 3 (primera réplica) mediante simulación de descendientes.

\hspace*{1em}
Las estimaciones de los componentes de varianza y de heredabilidad (en sentido estricto) para el carácter tiempo de floración, mediante procedimientos Bayesianos y de máxima verosimilitud restringida (REML) en los tres pedigríes generados a partir de la simulación ancestral, se resumen en las Figuras 5.3 y 5.4.

Se observaron valores altos de heredabilidad (mayores a 0.58), con densidades de marcadores variadas en 451 individuos genotipados (Figura 5.3), lo que indica que el tiempo de floración es un carácter muy heredable. Ambos enfoques (Bayesiano y REML), proporcionaron estimaciones de heredabilidad muy similares. Se pudo observar también que las varianzas genéticas aditivas obtenidas en el ssGBLUP fueron más bajas comparadas con las obtenidas a partir del BLUP (esto es, con una densidad de marcador igual a 0). A este respecto, los métodos de selección genómica basados en información de genotipos (como es el caso del ssGBLUP) pueden revelar relaciones entre individuos que aparentemente no están relacionados en el pedigrí [@cite:74], hecho que puede resultar en una mejor estimación de la varianza genética aditiva en los modelos de selección genómica y una sobreestimación en el BLUP [@cite:72], como se evidenció en este estudio.

<!--
\hspace*{1em}
\noindent
__Tabla 5.1:__ Estimaciones de componentes de varianza y de heredabilidad para el carácter tiempo de floración mediante el método BLUP en los tres pedigríes simulados mediante simulación ancestral.
-->
```{r, eval=FALSE, echo = FALSE, out.width = "100%", fig.align = 'center', warning = FALSE, message=FALSE}

tribble(
  ~'Parámetro', ~'Ped. 1', ~'Ped. 2', ~'Ped. 3', ~'Pedigrí_a', ~'Pedigrí_b', ~'Pedigrí_c',
  'Varianza aditiva', 0.43, 0.50, 0.56, 0.47, 0.50, 0.56,
  'Varianza ambiental', 0.16, 0.14, 0.11, 0.12, 0.13, 0.11,
  'Heredabilidad', 0.72, 0.78, 0.84, 0.80, 0.79, 0.84
  ) %>%
  gt() %>%
  cols_label(
    Pedigrí_a = 'Ped. 1',
    Pedigrí_b = 'Ped. 2',
    Pedigrí_c = 'Ped. 3'
  ) %>%
  tab_spanner(
    label = 'Bayesiano',
    columns = c(2, 3, 4)
    ) %>%
  tab_spanner(
    label = 'REML',
    columns = c(5, 6, 7)
    ) %>%
  tab_footnote(
    footnote = 'Ped. 1 indica Pedigrí 1',
    locations = cells_column_labels(
      columns = 'Ped. 1'
    )
  )
```

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message=FALSE, warning = FALSE}

param_gen <- read_delim(here('figures', 'param_gen.txt'), delim = '\t') %>%
  rename(Replica = Pedigrí) %>%
  mutate(
    Densidad = case_when(
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Ind_gen = as.factor(Ind_gen),
    Densidad = case_when(
      Ind_gen == '0' & Densidad == '1.000' ~ '0',
      Ind_gen == '0' & Densidad == '10.000' ~ '0',
      Ind_gen == '0' & Densidad == '100.000' ~ '0',
      Ind_gen == '148' & Densidad == '1.000' ~ '1.000',
      Ind_gen == '148' & Densidad == '10.000' ~ '10.000',
      Ind_gen == '148' & Densidad == '100.000' ~ '100.000',
      Ind_gen == '298' & Densidad == '1.000' ~ '1.000',
      Ind_gen == '298' & Densidad == '10.000' ~ '10.000',
      Ind_gen == '298' & Densidad == '100.000' ~ '100.000',
      Ind_gen == '451' & Densidad == '1.000' ~ '1.000',
      Ind_gen == '451' & Densidad == '10.000' ~ '10.000',
      Ind_gen == '451' & Densidad == '100.000' ~ '100.000'
      ),
    Pedigrí = case_when(
      grepl('Pedigrí 1.', Replica) ~ 'Pedigrí 1',
      grepl('Pedigrí 2.', Replica) ~ 'Pedigrí 2',
      grepl('Pedigrí 3.', Replica) ~ 'Pedigrí 3'
      )
    )

###################
# Enfoque Bayesiano
###################

# Pedigrí 1 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = 'Enfoque Bayesiano', subtitle = 'Pedigrí 1', y = 'Heredabilidad', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_bay_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', subtitle = ' ', y = 'Varianza del error', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_bay_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Enfoque Bayesiano', subtitle = 'Pedigrí 1', y = 'Varianza aditiva', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_bay_ped1

# Pedigrí 2 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 2', y = 'Heredabilidad', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_bay_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_bay_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Pedigrí 2', y = 'Varianza aditiva', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_bay_ped2

# Pedigrí 3 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'red', fill = 'red', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 3', y = 'Heredabilidad', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_bay_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_bay_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1), label.size = 0.04) +
  labs(title = 'Pedigrí 3', y = 'Varianza aditiva', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_bay_ped3

(Here_ind_gen_bay_ped1) | (Here_ind_gen_bay_ped2) / (Here_ind_gen_bay_ped3) -> param_Bayes

knitr::include_graphics('figures/param_Bayes.pdf', auto_pdf = TRUE)

##############
# Enfoque REML
##############

# Pedigrí 1 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = 'Enfoque REML', subtitle = 'Pedigrí 1', y = 'Heredabilidad', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_reml_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', subtitle = ' ', y = 'Varianza del error', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_reml_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Enfoque REML', subtitle = 'Pedigrí 1', y = 'Varianza aditiva', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_reml_ped1

# Pedigrí 2 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 2', y = 'Heredabilidad', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_reml_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_reml_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Pedigrí 2', y = 'Varianza aditiva', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_reml_ped2

# Pedigrí 3 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'red', fill = 'red', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 3', y = 'Heredabilidad', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_reml_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_reml_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Ind_gen %in% c('0', '451'),
    Enfoque == 'REML',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Densidad, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1), label.size = 0.04) +
  labs(title = 'Pedigrí 3', y = 'Varianza aditiva', x = 'Densidad del marcador') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_reml_ped3

(Here_ind_gen_reml_ped1) | (Here_ind_gen_reml_ped2) / (Here_ind_gen_reml_ped3) -> param_reml

knitr::include_graphics('figures/param_reml.pdf', auto_pdf = TRUE)
```

\noindent
__Figura 5.3:__ Estimaciones de componentes de varianza y de heredabilidad mediante enfoques Bayesiano y REML, para el carácter tiempo de floración con tamaños crecientes en el número de marcadores en 451 individuos genotipados (excepto con una densidad de 0 que correspondería a ningún individuo genotipado). Las barras representan la media del valor de heredabilidad obtenida de las 10 réplicas de cada pedigrí y Pedigrí 1-2-3 son los tres pedigríes simulados mediante simulación ancestral.

\hspace*{1em}
La heredabilidad estimada, según el conjunto completo de marcadores (100.231 SNP) en distintas cantidades de individuos genotipados (Figura 5.4), varió de  0.72 a 0.74. El valor de heredabilidad presentó distintas tendencias según el pedigrí, con un aumentó en dicho valor al aumentar el número de individuos genotipados (en el pedigrí 1), y caso contrario, una disminución en el valor de heredabilidad al aumentar el número de individuos genotipados (en los pedigríes 2 y 3). En ambos enfoques (Bayesiano y REML), no se observaron diferencias en la estima de heredabilidad. Se evidenció también que las estimaciones de los componentes de varianzas genético aditivo y residual disminuyeron continuamente según la cantidad de individuos genotipados. Al comparar las estimas de los componentes de varianzas genético aditivo y residual, no se observaron diferencias entre ambos enfoques.

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message=FALSE, warning = FALSE}

param_gen <- read_delim(here('figures', 'param_gen.txt'), delim = '\t') %>%
  rename(Replica = Pedigrí) %>%
  mutate(
    Densidad = case_when(
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Ind_gen = as.factor(Ind_gen),
    Densidad = case_when(
      Ind_gen == '0' & Densidad == '1.000' ~ '0',
      Ind_gen == '0' & Densidad == '10.000' ~ '0',
      Ind_gen == '0' & Densidad == '100.000' ~ '0',
      Ind_gen == '148' & Densidad == '1.000' ~ '1.000',
      Ind_gen == '148' & Densidad == '10.000' ~ '10.000',
      Ind_gen == '148' & Densidad == '100.000' ~ '100.000',
      Ind_gen == '298' & Densidad == '1.000' ~ '1.000',
      Ind_gen == '298' & Densidad == '10.000' ~ '10.000',
      Ind_gen == '298' & Densidad == '100.000' ~ '100.000',
      Ind_gen == '451' & Densidad == '1.000' ~ '1.000',
      Ind_gen == '451' & Densidad == '10.000' ~ '10.000',
      Ind_gen == '451' & Densidad == '100.000' ~ '100.000'
      ),
    Pedigrí = case_when(
      grepl('Pedigrí 1.', Replica) ~ 'Pedigrí 1',
      grepl('Pedigrí 2.', Replica) ~ 'Pedigrí 2',
      grepl('Pedigrí 3.', Replica) ~ 'Pedigrí 3'
      )
    )

###################
# Enfoque Bayesiano
###################

# Pedigrí 1 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = 'Enfoque Bayesiano', subtitle = 'Pedigrí 1', y = 'Heredabilidad', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_bay_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', subtitle = ' ', y = 'Varianza del error', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_bay_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Enfoque Bayesiano', subtitle = 'Pedigrí 1', y = 'Varianza aditiva', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_bay_ped1

# Pedigrí 2 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 2', y = 'Heredabilidad', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_bay_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_bay_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Pedigrí 2', y = 'Varianza aditiva', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_bay_ped2

# Pedigrí 3 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'red', fill = 'red', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 3', y = 'Heredabilidad', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_bay_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_bay_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1), label.size = 0.04) +
  labs(title = 'Pedigrí 3', y = 'Varianza aditiva', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_bay_ped3

(Here_ind_gen_bay_ped1) | (Here_ind_gen_bay_ped2) / (Here_ind_gen_bay_ped3) -> param_Bayes_2

knitr::include_graphics('figures/param_Bayes_2.pdf', auto_pdf = TRUE)

##############
# Enfoque REML
##############

# Pedigrí 1 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = 'Enfoque REML', subtitle = 'Pedigrí 1', y = 'Heredabilidad', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_reml_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', subtitle = ' ', y = 'Varianza del error', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_reml_ped1

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 1'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Enfoque REML', subtitle = 'Pedigrí 1', y = 'Varianza aditiva', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 11, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_reml_ped1

# Pedigrí 2 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 2', y = 'Heredabilidad', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_reml_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_reml_ped2

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 2'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = 'Pedigrí 2', y = 'Varianza aditiva', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_reml_ped2

# Pedigrí 3 ----

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(h2, na.rm = TRUE), digits = 3),
    prom = round(mean(h2), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'red', fill = 'red', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  labs(title = ' ', subtitle = 'Pedigrí 3', y = 'Heredabilidad', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> Here_ind_gen_reml_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varE, na.rm = TRUE), digits = 3),
    prom = round(mean(varE), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'cyan', fill = 'cyan', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1)) +
  labs(title = ' ', y = 'Varianza del error', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varE_ind_gen_reml_ped3

param_gen %>%
  group_by(Densidad, Ind_gen, Enfoque, Pedigrí) %>%
  summarise(
    des = round(sd(varU, na.rm = TRUE), digits = 3),
    prom = round(mean(varU), digits = 3)
    ) %>%
  ungroup() %>%
  filter(
    Densidad %in% c('0', '100.000'),
    Enfoque == 'Bayesiano',
    Pedigrí == 'Pedigrí 3'
    ) %>%
  ggplot(data = .,aes(x = Ind_gen, y = prom)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, colour = 'yellow', fill = 'yellow', alpha = 0.4) +
  #geom_label(aes(label = round(prom, digits = 2)), colour = 'black', position = position_dodge(width = 1), label.size = 0.04) +
  labs(title = 'Pedigrí 3', y = 'Varianza aditiva', x = 'Individuos genotipados') +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 10, face = 'bold'),
    axis.text.x = element_text(size = 7.4, face = 'bold'),
    axis.title = element_text(size = 10, face = 'bold'),
    plot.title = element_text(size = 10, face = 'bold'),
    plot.subtitle = element_text(size = 10, face = 'bold')
    ) -> varA_ind_gen_reml_ped3

(Here_ind_gen_reml_ped1) | (Here_ind_gen_reml_ped2) / (Here_ind_gen_reml_ped3) -> param_reml_2

knitr::include_graphics('figures/param_reml_2.pdf', auto_pdf = TRUE)
```

\noindent
__Figura 5.4:__ Estimaciones de componentes de varianza y de heredabilidad mediante enfoques Bayesiano y REML, para el carácter tiempo de floración con tamaños crecientes en el número de individuos genotipados con una densidad aproximada de 100.000 marcadores. Las barras representan la media del valor de heredabilidad obtenida de las 10 réplicas de cada pedigrí y Pedigrí 1-2-3 son los tres pedigríes simulados mediante simulación ancestral.

```{r, eval=FALSE, echo = FALSE, out.width = "100%", fig.align = 'center', message=FALSE, warning = FALSE}

# Pedigrí 1 (Bayesiano) ----

varU_ped_1 <- read_delim(here('figures', 'varU_ped1.txt'), delim = '\t') %>%
  mutate(varU = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varE_ped_1 <- read_delim(here('figures', 'varE_ped1.txt'), delim = '\t') %>%
  mutate(varE = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

h2_ped_1 <- read_delim(here('figures', 'h2_ped1.txt'), delim = '\t') %>%
  mutate(h2 = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varU_ped1 <- ggplot(data = varU_ped_1, aes(x = varU)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.2) +
  annotate(geom = 'text', x = 0.48, y = 15, label = TeX('$|0.36; 0.51|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.48, y = 13, label = TeX('$\\bar{x} = 0.43$'), size = 4.8) +
  labs(title = 'Pedigrí 1 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_ped1 <- ggplot(data = varE_ped_1, aes(x = varE)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.2) +
  annotate(geom = 'text', x = 0.20, y = 25, label = TeX('$|0.13; 0.23|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.20, y = 23, label = TeX('$\\bar{x} = 0.16$'), size = 4.8) +
  labs(title = 'Pedigrí 1 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_ped1 <- ggplot(data = h2_ped_1, aes(x = h2)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  annotate(geom = 'text', x = 0.65, y = 15, label = TeX('$|0.62; 0.79|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.77, y = 13, label = TeX('$\\bar{x} = 0.72$'), size = 4.8) +
  labs(title = 'Pedigrí 1 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

# Pedigrí 2 (Bayesiano) ----

varU_ped_2 <- read_delim(here('figures', 'varU_ped2.txt'), delim = '\t') %>%
  mutate(varU = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varE_ped_2 <- read_delim(here('figures', 'varE_ped2.txt'), delim = '\t') %>%
  mutate(varE = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

h2_ped_2 <- read_delim(here('figures', 'h2_ped2.txt'), delim = '\t') %>%
  mutate(h2 = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varU_ped2 <- ggplot(data = varU_ped_2, aes(x = varU)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.2) +
  annotate(geom = 'text', x = 0.43, y = 14, label = TeX('$|0.40; 0.58|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.48, y = 13, label = TeX('$\\bar{x} = 0.50$'), size = 4.8) +
  labs(title = 'Pedigrí 2 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_ped2 <- ggplot(data = varE_ped_2, aes(x = varE)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.2) +
  annotate(geom = 'text', x = 0.17, y = 24, label = TeX('$|0.10; 0.19|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.20, y = 23, label = TeX('$\\bar{x} = 0.14$'), size = 4.8) +
  labs(title = 'Pedigrí 2 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_ped2 <- ggplot(data = h2_ped_2, aes(x = h2)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  annotate(geom = 'text', x = 0.72, y = 14, label = TeX('$|0.69; 0.85|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.77, y = 13, label = TeX('$\\bar{x} = 0.78$'), size = 4.8) +
  labs(title = 'Pedigrí 2 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

# Pedigrí 3 (Bayesiano) ----

varU_ped_3 <- read_delim(here('figures', 'varU_ped3.txt'), delim = '\t') %>%
  mutate(varU = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varE_ped_3 <- read_delim(here('figures', 'varE_ped3.txt'), delim = '\t') %>%
  mutate(varE = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

h2_ped_3 <- read_delim(here('figures', 'h2_ped3.txt'), delim = '\t') %>%
  mutate(h2 = (value...1 + value...2 + value...3 + value...4 + value...5 + value...6 + value...7 + value...8 + value...9 + value...10)/10)

varU_ped3 <- ggplot(data = varU_ped_3, aes(x = varU)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.2) +
  annotate(geom = 'text', x = 0.475, y = 14, label = TeX('$|0.35; 0.65|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.48, y = 13, label = TeX('$\\bar{x} = 0.56$'), size = 4.8) +
  labs(title = 'Pedigrí 3 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_ped3 <- ggplot(data = varE_ped_3, aes(x = varE)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.2) +
  annotate(geom = 'text', x = 0.14, y = 24, label = TeX('$|0.08; 0.16|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.20, y = 23, label = TeX('$\\bar{x} = 0.11$'), size = 4.8) +
  labs(title = 'Pedigrí 3 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 9, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_ped3 <- ggplot(data = h2_ped_3, aes(x = h2)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  annotate(geom = 'text', x = 0.786, y = 14, label = TeX('$|0.76; 0.89|$'), size = 3.2) +
  #annotate(geom = 'text', x = 0.77, y = 13, label = TeX('$\\bar{x} = 0.83$'), size = 4.8) +
  labs(title = 'Pedigrí 3 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 10, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

(varU_ped1 | varE_ped1 | h2_ped1) / (varU_ped2 | varE_ped2 | h2_ped2) / (varU_ped3 | varE_ped3 | h2_ped3) -> covar_h2

(h2_ped1 | h2_ped2 | h2_ped3) -> covar_h2_2

knitr::include_graphics('figures/covar_h2.pdf', auto_pdf = TRUE)
```
<!--
\noindent
__Figura 5.4:__ Distribuciones posteriores de componentes de varianza y de heredabilidad obtenidas mediante enfoques Bayesianos. Los valores presentados en la Figura 5.3 (para el enfoque Bayesiano y con una densidad de marcadores de 0), corresponden a la media calculada a partir de estas distribuciones.-->

## Precisión de la predición mediante simulación del pedigrí ancestral

El efecto de la densidad del marcador y de la cantidad de individuos genotipados sobre la precisión de la predicción, se evaluó a través del coeficiente de correlación entre los valores fenotípicos observados y predichos. Los resultados se resumen en la Figura 5.5 y en el Anexo A.3. En general, y como era de esperar, la precisión de la predicción aumentó a medida que aumentaban tanto la densidad del marcador como la cantidad de individuos genotipados.

La precisión de la predicción debido a la densidad del marcador (Figura 5.5 y Anexo A.3), fue mayor cuando no se utilizó información genómica en comparación a una densidad aproximada de 1.000 (en todos los casos de individuos genotipados). Al considerar una densidad del marcador por encima de 1.000, dicha precisión tendió a aumentar hasta alcanzar la precisión de la predicción más alta cuando se usaron todos los marcadores disponibles (aunque al considerar el genotipado de 148 individuos, la precisión de la predicción usando 10.000 y 100.000 marcadores no pudo superar el caso donde no se utilizó información genómica). Sin embargo, dado el aumento marginal en la precisión de la predicción al aumentar de 10.000 a 100.000 marcadores, se puede afirmar que el límite en el aumento de la precisión se alcanzó en aproximadamente 10.000 marcadores. Por otra parte, el desvío estándar de las precisiones de predicción fue similar, independientemente del número de marcadores. Este comportamiento de la densidad del marcador sobre la precisión de la predicción curiosamente se observó por igual en los tres pedigríes simulados, tanto en el enfoque Bayesiano como en REML.

En cuanto a la cantidad de individuos genotipados, la precisión de la predicción aumentó sustancialmente al pasar de 148 a 451 individuos genotipados (en todos los casos de densidades de SNP). A diferencia de lo mencionado en el párrafo anterior para la densidad del marcador, no se pudo observar un punto en el que la precisión de la predicción se estabilizara en respuesta al aumento en la cantidad de individuos genotipados. Esto demuestra la importancia de un tamaño adecuado del conjunto de entrenamiento para construir modelos de predicción genómica. Adicionalmente, él desvió estándar de las precisiones disminuyo a medida que aumentaba la cantidad de individuos genotipados<!--, hecho que pone de manifiesto que la diferencia en la precisión de la predicción es más alta en conjuntos de entrenamiento más pequeños-->. Al igual que lo mencionado en el párrafo anterior para la densidad del marcador, se observó un comportamiento muy similar en la precisión de la predicción debido a la cantidad de individuos genotipados en los tres pedigríes simulados y en ambos enfoques (Bayesiano y REML).

```{r, eval = FALSE, echo = FALSE}

####################
# Enfoque penalizado
####################

Ped1_Pen <- read_delim(here('figures', 'Ped1_Pen.txt'), delim = '\t') %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 1'
    )

# Diferencias entre distintos individuos genotipados con una densidad de SNP de 1.000 y con el enfoque REML ----

Ped1_Pen_1.000 <- Ped1_Pen %>%
  filter(Densidad == '1.000' | Densidad == '0')

mod_comp_1 <- aov(formula = Correlación ~ Genotipados, data = Ped1_Pen_1.000)
summary(mod_comp_1)
TukeyHSD(mod_comp_1) # Aquí se ve que no hay diferencias entre 148-298, 148-451, pero si hay diferencia entre 298-451.

# Diferencias entre distintos individuos genotipados con una densidad de SNP de 10.000 y con el enfoque REML ----

Ped1_Pen_10.000 <- Ped1_Pen %>%
  filter(Densidad == '10.000' | Densidad == '0')

mod_comp_2 <- aov(formula = Correlación ~ Genotipados, data = Ped1_Pen_10.000)
summary(mod_comp_2)
TukeyHSD(mod_comp_2) # Aquí se ve que no hay diferencia entre 148-298, pero si hay diferencias entre 148-451 y 298-451.

# Diferencias entre distintos individuos genotipados con una densidad de SNP de 100.000 y con el enfoque REML ----

Ped1_Pen_100.000 <- Ped1_Pen %>%
  filter(Densidad == '100.000' | Densidad == '0')

mod_comp_3 <- aov(formula = Correlación ~ Genotipados, data = Ped1_Pen_100.000)
summary(mod_comp_3)
TukeyHSD(mod_comp_3) # Aquí se ve que hay diferencias entre 148-298, 148-451 y 298-451.
```

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

Cor_ped_1_est <- read_delim(here('figures', 'Ped1_Bay_Pen.txt'), delim = '\t') %>%
  mutate(
    Enfoque = recode(
      .x = Enfoque,
      'Penalizado' = 'REML'
      )
    ) %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 1'
    )

Cor_ped_1_est %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(data = Cor_ped_1_est, position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), data = Cor_ped_1_est, width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_wrap(~ Enfoque) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador', title = 'Pedigrí uno') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = 'bold'),
    legend.title = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 13, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) -> Cor_ped_1_est_graf

Cor_ped_2_est <- read_delim(here('figures', 'Ped2_Bay_Pen.txt'), delim = '\t') %>%
  mutate(
    Enfoque = recode(
      .x = Enfoque,
      'Penalizado' = 'REML'
      )
    ) %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 2'
    )

Cor_ped_2_est %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(data = Cor_ped_2_est, position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), data = Cor_ped_2_est, width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_wrap(~ Enfoque) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador', title = 'Pedigrí dos') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = 'bold'),
    legend.title = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 13, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) -> Cor_ped_2_est_graf

Cor_ped_3_est <- read_delim(here('figures', 'Ped3_Bay_Pen.txt'), delim = '\t') %>%
  mutate(
    Enfoque = recode(
      .x = Enfoque,
      'Penalizado' = 'REML'
      )
    ) %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Genotipados = as.factor(Genotipados),
    Pedigrí = 'Pedigrí 3'
    )

Cor_ped_3_est %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(data = Cor_ped_3_est, position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), data = Cor_ped_3_est, width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_wrap(~ Enfoque) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador', title = 'Pedigrí tres') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = 'bold'),
    legend.title = element_text(size = 14, face = 'bold'),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 13, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) -> Cor_ped_3_est_graf

bind_rows(Cor_ped_1_est, Cor_ped_2_est, Cor_ped_3_est) %>%
  ggplot(data = .,aes(x = Densidad, y = Correlación, fill = Genotipados, colour = Genotipados)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Correlación - des, ymax = Correlación + des), width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_grid(vars(Pedigrí), vars(Enfoque)) +
  annotate(geom = 'text', x = 1.78, y = 0.72, label = 'bc', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 2.0, y = 0.72, label = 'b', size = 2.8, colour = 'black') +
  facet_grid(vars(Pedigrí), vars(Enfoque)) +
  annotate(geom = 'text', x = 1.0, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 2.25, y = 0.72, label = 'ac', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 2.78, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 3.0, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 3.78, y = 0.72, label = 'a', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 4.0, y = 0.72, label = 'ab', size = 2.8, colour = 'black') +
  annotate(geom = 'text', x = 4.22, y = 0.72, label = 'b', size = 2.8, colour = 'black') +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 11, face = 'bold'),
    legend.title = element_text(size = 11, face = 'bold'),
    legend.text = element_text(size = 11),
    legend.position = 'top',
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 10, colour = 'black', face = 'bold')
    ) -> Cor_Bay_Pen

knitr::include_graphics('figures/Cor_Bay_Pen_2.pdf', auto_pdf = TRUE)
```

\noindent
__Figura 5.5:__ Precisión de la predicción con tamaños crecientes en el número de marcadores y de individuos genotipados en la simulación ancestral para los tres pedigríes simulados. Las barras representan la media de la precisión de la predicción de las 10 réplicas de cada pedigrí y las barras de error representan el desvío estándar como medida de variabilidad.

## Precisión de la predición mediante simulación de descendientes

\hspace*{1em}
El efecto de la densidad del marcador sobre la precisión de la predicción también se evaluó en la simulación de descendientes (Figura 5.6 y Anexo A.4), observándose en éste un comportamiento similar al observado con la simulación ancestral, en el sentido de que fue necesario de una cantidad mínima de marcadores para obtener una precisión equivalente al usar la cantidad máxima, aunque en esta simulación dicha cantidad mínima de marcadores fue solo de aproximadamente 1.000. Se observó un aumento irrelevante en la precisión de la predicción al pasar de 1.000 a 10.000 marcadores y de 10.000 a 100.000 marcadores (~ 0.0 %), para todos los casos de individuos genotipados. La diferencia con el escenario anterior (simulación ancestral) es que en este caso el desequilibrio fue mucho mayor, ya que los descendientes se generaron a partir de los parentales, mientras que en el caso anterior el desequilibrio es el observado en la población. Las mayores ganancias esperadas en la precisión de la predicción se observaron al pasar de 0 a 1.000, 10.000 y 100.000 marcadores, demostrando con esto que las predicciones basadas en información genómica son más precisas que las predicciones basadas solo en información del pedigrí. Este comportamiento de la densidad del marcador sobre la precisión de la predicción se observó por igual en los cuatro pedigríes simulados y considerando los individuos de las generaciones F2 y F3 como conjuntos de validación.

Respecto a la cantidad de individuos genotipados, también se observo una tendencia similar al observado con la simulación ancestral. La precisión de la predicción aumento al aumentar la cantidad de individuos genotipados, observándose una estabilización al considerar un tamaño de genotipado entre solo los individuos de la generación $F_{1}$ y los individuos de las generaciones $F_{1}$ y $F_{2}$. La mayor precisión de la predicción se observó al genotipar los individuos de todas las generaciones ($F_{0}$, $F_{1}$, $F_{2}$ y $F_{3}$), logrando una ganancia esperada en la precisión mínima del 3.1% (en el pedigrí 2) y máxima del 13.0% (en el pedigrí 4), al considerar una densidad de 1.000 y 100.000 marcadores, respectivamente.

```{r, echo = FALSE, out.width = "100%", fig.align = 'center', message = FALSE}

Cor_F2_est <- read_delim(here('figures', 'Ped_F2.txt'), delim = '\t') %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Predicción = 'F2',
    Pedigrí = case_when(
      Pedigrí == 'Pedigrí_1' ~ 'Pedigrí 1',
      Pedigrí == 'Pedigrí_2' ~ 'Pedigrí 2',
      Pedigrí == 'Pedigrí_3' ~ 'Pedigrí 3',
      Pedigrí == 'Pedigrí_4' ~ 'Pedigrí 4'
      )
    )

Cor_F3_est <- read_delim(here('figures', 'Ped_F3.txt'), delim = '\t') %>%
  mutate(
    Densidad = case_when(
      Densidad == 0 ~ '0',
      Densidad == 1 ~ '1.000',
      Densidad == 10 ~ '10.000',
      Densidad == 100 ~ '100.000'
      ),
    Predicción = 'F3',
    Pedigrí = case_when(
      Pedigrí == 'Pedigrí_1' ~ 'Pedigrí 1',
      Pedigrí == 'Pedigrí_2' ~ 'Pedigrí 2',
      Pedigrí == 'Pedigrí_3' ~ 'Pedigrí 3',
      Pedigrí == 'Pedigrí_4' ~ 'Pedigrí 4'
      )
  )

bind_rows(Cor_F2_est, Cor_F3_est) %>%
  mutate(Genotipados = factor(Genotipados, levels = c('Ninguno', 'F2', 'F1-F2', 'F0-F1-F2-F3'))) %>%
  ggplot(data = .,aes(x = Densidad, y = Media, fill = Genotipados, colour = Genotipados)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6, alpha = 0.4) +
  #geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.4) +
  geom_errorbar(aes(ymin = Media - Desvio, ymax = Media + Desvio), width = 0.2, position = position_dodge(width = 0.7)) +
  scale_y_continuous(limits = c(0.0, 1.0)) +
  facet_grid(vars(Pedigrí), vars(Predicción)) +
  labs(y = 'Precisión de la predicción', x = 'Densidad del marcador') +
  scale_colour_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  scale_fill_manual(values = c('black', 'yellow', 'cyan', 'red')) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 11, face = 'bold'),
    legend.title = element_text(size = 11, face = 'bold'),
    legend.text = element_text(size = 11),
    legend.position = 'top',
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 10, colour = 'black', face = 'bold')
    ) -> Cor_F2_F3

knitr::include_graphics('figures/Cor_F2_F3.pdf', auto_pdf = TRUE)
```

\noindent
__Figura 5.6:__ Precisión de la predicción con tamaños crecientes en el número de marcadores y de individuos genotipados en la simulación de descendientes para los cuatro pedigríes simulados. Las barras representan la media de la precisión de la predicción de las 10 réplicas de cada pedigrí y las barras de error representan el desvío estándar como medida de variabilidad.

